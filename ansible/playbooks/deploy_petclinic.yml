---
################################################################################
# Playbook: deploy-petclinic.yml
# Description: Deploy PetClinic WAR to Tomcat and run sanity checks
################################################################################

- name: Deploy PetClinic to Tomcat
  hosts: localhost
  become: no
  vars:
    app_user: "pet-clinic"
    war_file: "/home/{{ app_user }}/build/petclinic.war"
    tomcat_home: "/home/{{ app_user }}/tomcat"
    tomcat_port: 9090
    app_context: "petclinic"
    java_home: "/home/{{ app_user }}/java/jdk25"  # Using Java 25 to match Tomcat 10 setup
    
  tasks:
    - name: Check if WAR file exists
      stat:
        path: "{{ war_file }}"
      register: war_check
      
    - name: Fail if WAR not found
      fail:
        msg: "WAR file not found at {{ war_file }}. Run build script first!"
      when: not war_check.stat.exists

    - name: Check if Tomcat is running
      shell: |
        if [ -f {{ tomcat_home }}/tomcat.pid ]; then
          PID=$(cat {{ tomcat_home }}/tomcat.pid)
          if ps -p $PID > /dev/null 2>&1; then
            echo "running"
          else
            echo "stopped"
          fi
        else
          echo "stopped"
        fi
      register: tomcat_status
      changed_when: false

    - name: Stop Tomcat if running
      shell: |
        export JAVA_HOME={{ java_home }}
        export PATH=$JAVA_HOME/bin:$PATH
        {{ tomcat_home }}/bin/shutdown.sh
      when: tomcat_status.stdout == "running"
      ignore_errors: yes

    - name: Wait for Tomcat to stop
      wait_for:
        port: "{{ tomcat_port }}"
        state: stopped
        timeout: 30
      when: tomcat_status.stdout == "running"
      ignore_errors: yes

    - name: Remove old application directory
      file:
        path: "{{ tomcat_home }}/webapps/{{ app_context }}"
        state: absent

    - name: Remove old WAR file
      file:
        path: "{{ tomcat_home }}/webapps/{{ app_context }}.war"
        state: absent

    - name: Deploy new WAR file
      copy:
        src: "{{ war_file }}"
        dest: "{{ tomcat_home }}/webapps/{{ app_context }}.war"
        remote_src: yes
        mode: '0644'

    - name: Start Tomcat with Java 25
      shell: |
        export JAVA_HOME={{ java_home }}
        export PATH=$JAVA_HOME/bin:$PATH
        {{ tomcat_home }}/bin/startup.sh
      register: tomcat_start

    - name: Wait for Tomcat to start
      wait_for:
        port: "{{ tomcat_port }}"
        delay: 5
        timeout: 60

    - name: Display deployment summary
      debug:
        msg:
          - "╔════════════════════════════════════════════════════════════╗"
          - "║           ✓ PetClinic Deployment Complete!                ║"
          - "╚════════════════════════════════════════════════════════════╝"
          - ""
          - "Deployment Details:"
          - "  WAR File      : {{ war_file }}"
          - "  Deployed To   : {{ tomcat_home }}/webapps/{{ app_context }}.war"
          - "  Tomcat Home   : {{ tomcat_home }}"
          - "  Tomcat Port   : {{ tomcat_port }}"
          - "  Java Runtime  : Java 25"
          - "  Application   : http://localhost:{{ tomcat_port }}/{{ app_context }}"
          - ""
          - "Next Step:"
          - "  Run verification: ansible-playbook verify_petclinic.yml"
          - ""
          - "╚════════════════════════════════════════════════════════════╝"
